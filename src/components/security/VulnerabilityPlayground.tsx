"use client";

import React, { useState } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Progress } from '@/components/ui/progress';
import { 
  Search, FileText, Shield, Database, HardDrive, 
  Activity, AlertTriangle, CheckCircle, Lock, Unlock,
  Eye, Download, RefreshCw, Terminal, Code, Globe
} from 'lucide-react';

interface LogEntry {
  timestamp: string;
  level: 'info' | 'warning' | 'error' | 'critical';
  source: string;
  message: string;
  ip?: string;
}

interface FileIntegrityResult {
  path: string;
  status: 'clean' | 'modified' | 'suspicious' | 'malicious';
  hash: string;
  expectedHash?: string;
  lastModified: string;
}

interface NetworkConnection {
  localPort: number;
  remoteIP: string;
  remotePort: number;
  state: string;
  process: string;
  suspicious: boolean;
}

export default function VulnerabilityPlayground() {
  const [scanning, setScanning] = useState(false);
  const [scanProgress, setScanProgress] = useState(0);
  const [logEntries, setLogEntries] = useState<LogEntry[]>([]);
  const [fileResults, setFileResults] = useState<FileIntegrityResult[]>([]);
  const [networkConnections, setNetworkConnections] = useState<NetworkConnection[]>([]);

  // Simulate log analysis
  const generateSampleLogs = (): LogEntry[] => {
    return [
      {
        timestamp: '2024-11-04 14:23:45',
        level: 'critical',
        source: 'Authentication',
        message: 'Multiple failed login attempts from IP 192.168.1.100',
        ip: '192.168.1.100'
      },
      {
        timestamp: '2024-11-04 14:22:31',
        level: 'error',
        source: 'SQL',
        message: 'SQL injection attempt detected in login form',
        ip: '45.67.89.123'
      },
      {
        timestamp: '2024-11-04 14:20:15',
        level: 'warning',
        source: 'FileSystem',
        message: 'Suspicious file access: /etc/passwd',
        ip: '192.168.1.50'
      },
      {
        timestamp: '2024-11-04 14:18:42',
        level: 'critical',
        source: 'Network',
        message: 'Unusual outbound traffic to unknown IP',
        ip: '198.51.100.42'
      },
      {
        timestamp: '2024-11-04 14:15:20',
        level: 'error',
        source: 'XSS',
        message: 'Cross-site scripting attempt in search parameter',
        ip: '203.0.113.5'
      },
      {
        timestamp: '2024-11-04 14:10:05',
        level: 'warning',
        source: 'Session',
        message: 'Session hijacking attempt detected',
        ip: '192.168.1.75'
      },
      {
        timestamp: '2024-11-04 14:05:33',
        level: 'info',
        source: 'Authentication',
        message: 'Successful login from admin user',
        ip: '192.168.1.10'
      },
      {
        timestamp: '2024-11-04 14:00:12',
        level: 'warning',
        source: 'Upload',
        message: 'Suspicious file upload attempt: shell.php',
        ip: '45.67.89.200'
      }
    ];
  };

  // Simulate file integrity check
  const generateFileResults = (): FileIntegrityResult[] => {
    return [
      {
        path: 'C:\\Windows\\System32\\kernel32.dll',
        status: 'modified',
        hash: 'a1b2c3d4e5f6...',
        expectedHash: 'x1y2z3a4b5c6...',
        lastModified: '2024-11-03 22:15:30'
      },
      {
        path: 'C:\\Program Files\\App\\config.ini',
        status: 'malicious',
        hash: 'deadbeef1234...',
        lastModified: '2024-11-04 03:45:12'
      },
      {
        path: 'C:\\Users\\Admin\\suspicious.exe',
        status: 'suspicious',
        hash: '9876543210ab...',
        lastModified: '2024-11-04 12:30:00'
      },
      {
        path: 'C:\\Windows\\System32\\cmd.exe',
        status: 'clean',
        hash: 'valid123hash...',
        expectedHash: 'valid123hash...',
        lastModified: '2024-01-15 10:00:00'
      },
      {
        path: '/var/www/html/index.php',
        status: 'modified',
        hash: 'modified456...',
        expectedHash: 'original789...',
        lastModified: '2024-11-04 08:20:15'
      }
    ];
  };

  // Simulate network analysis
  const generateNetworkConnections = (): NetworkConnection[] => {
    return [
      {
        localPort: 443,
        remoteIP: '142.250.185.46',
        remotePort: 443,
        state: 'ESTABLISHED',
        process: 'chrome.exe',
        suspicious: false
      },
      {
        localPort: 4444,
        remoteIP: '198.51.100.42',
        remotePort: 31337,
        state: 'ESTABLISHED',
        process: 'unknown.exe',
        suspicious: true
      },
      {
        localPort: 3389,
        remoteIP: '45.67.89.123',
        remotePort: 12345,
        state: 'LISTENING',
        process: 'svchost.exe',
        suspicious: true
      },
      {
        localPort: 80,
        remoteIP: '93.184.216.34',
        remotePort: 80,
        state: 'ESTABLISHED',
        process: 'nginx',
        suspicious: false
      },
      {
        localPort: 22,
        remoteIP: '203.0.113.5',
        remotePort: 54321,
        state: 'ESTABLISHED',
        process: 'sshd',
        suspicious: true
      }
    ];
  };

  const handleStartScan = () => {
    setScanning(true);
    setScanProgress(0);

    const interval = setInterval(() => {
      setScanProgress((prev) => {
        if (prev >= 100) {
          clearInterval(interval);
          setScanning(false);
          setLogEntries(generateSampleLogs());
          setFileResults(generateFileResults());
          setNetworkConnections(generateNetworkConnections());
          return 100;
        }
        return prev + 10;
      });
    }, 300);
  };

  const getLevelBadge = (level: string) => {
    const colors = {
      info: 'bg-blue-100 text-blue-800',
      warning: 'bg-yellow-100 text-yellow-800',
      error: 'bg-orange-100 text-orange-800',
      critical: 'bg-red-100 text-red-800'
    };
    return colors[level as keyof typeof colors] || colors.info;
  };

  const getStatusColor = (status: string) => {
    const colors = {
      clean: 'text-green-600',
      modified: 'text-yellow-600',
      suspicious: 'text-orange-600',
      malicious: 'text-red-600'
    };
    return colors[status as keyof typeof colors] || 'text-gray-600';
  };

  return (
    <div className="container mx-auto p-4 space-y-6">
      {/* Header */}
      <div className="text-center space-y-2">
        <h1 className="text-4xl font-bold">ðŸ”¬ Vulnerability Playground</h1>
        <p className="text-gray-600">Practice security analysis and forensic investigation</p>
      </div>

      {/* Quick Scan Button */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center">
            <Search className="mr-2 h-5 w-5" />
            Comprehensive Security Scan
          </CardTitle>
          <CardDescription>
            Scan for vulnerabilities, analyze logs, and check file integrity
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <Button 
            onClick={handleStartScan} 
            disabled={scanning}
            size="lg"
            className="w-full"
          >
            {scanning ? (
              <>
                <RefreshCw className="mr-2 h-5 w-5 animate-spin" />
                Scanning...
              </>
            ) : (
              <>
                <Search className="mr-2 h-5 w-5" />
                Start Full Scan
              </>
            )}
          </Button>

          {scanning && (
            <div className="space-y-2">
              <Progress value={scanProgress} />
              <p className="text-sm text-center text-gray-600">
                Scanning system... {scanProgress}%
              </p>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Results Tabs */}
      {(logEntries.length > 0 || fileResults.length > 0 || networkConnections.length > 0) && (
        <Tabs defaultValue="logs" className="w-full">
          <TabsList className="grid w-full grid-cols-4">
            <TabsTrigger value="logs">
              <FileText className="mr-2 h-4 w-4" />
              Logs
            </TabsTrigger>
            <TabsTrigger value="files">
              <HardDrive className="mr-2 h-4 w-4" />
              Files
            </TabsTrigger>
            <TabsTrigger value="network">
              <Globe className="mr-2 h-4 w-4" />
              Network
            </TabsTrigger>
            <TabsTrigger value="exploits">
              <Code className="mr-2 h-4 w-4" />
              Exploits
            </TabsTrigger>
          </TabsList>

          {/* Log Analysis Tab */}
          <TabsContent value="logs" className="space-y-4">
            <Card>
              <CardHeader>
                <CardTitle>Security Log Analysis</CardTitle>
                <CardDescription>
                  Found {logEntries.filter(l => l.level === 'critical' || l.level === 'error').length} critical issues
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="space-y-2 max-h-[500px] overflow-y-auto">
                  {logEntries.map((log, idx) => (
                    <div 
                      key={idx}
                      className="p-3 border rounded-lg hover:shadow-md transition-shadow"
                    >
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <div className="flex items-center space-x-2 mb-1">
                            <Badge className={getLevelBadge(log.level)}>
                              {log.level.toUpperCase()}
                            </Badge>
                            <span className="text-sm font-semibold">{log.source}</span>
                            <span className="text-xs text-gray-500">{log.timestamp}</span>
                          </div>
                          <p className="text-sm">{log.message}</p>
                          {log.ip && (
                            <p className="text-xs text-gray-600 mt-1">
                              IP Address: <code className="bg-gray-100 px-1 rounded">{log.ip}</code>
                            </p>
                          )}
                        </div>
                        <Button size="sm" variant="outline">
                          <Eye className="h-4 w-4" />
                        </Button>
                      </div>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* File Integrity Tab */}
          <TabsContent value="files" className="space-y-4">
            <Card>
              <CardHeader>
                <CardTitle>File Integrity Check</CardTitle>
                <CardDescription>
                  Found {fileResults.filter(f => f.status !== 'clean').length} suspicious files
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="space-y-2 max-h-[500px] overflow-y-auto">
                  {fileResults.map((file, idx) => (
                    <div 
                      key={idx}
                      className={`p-3 border rounded-lg ${
                        file.status === 'malicious' ? 'border-red-300 bg-red-50' :
                        file.status === 'suspicious' ? 'border-orange-300 bg-orange-50' :
                        file.status === 'modified' ? 'border-yellow-300 bg-yellow-50' :
                        'border-green-300 bg-green-50'
                      }`}
                    >
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <div className="flex items-center space-x-2 mb-1">
                            {file.status === 'clean' ? (
                              <CheckCircle className="h-4 w-4 text-green-600" />
                            ) : (
                              <AlertTriangle className={`h-4 w-4 ${getStatusColor(file.status)}`} />
                            )}
                            <span className={`text-sm font-semibold ${getStatusColor(file.status)}`}>
                              {file.status.toUpperCase()}
                            </span>
                          </div>
                          <p className="text-sm font-mono break-all">{file.path}</p>
                          <div className="text-xs text-gray-600 mt-1 space-y-1">
                            <p>Hash: <code className="bg-white px-1 rounded">{file.hash}</code></p>
                            {file.expectedHash && (
                              <p>Expected: <code className="bg-white px-1 rounded">{file.expectedHash}</code></p>
                            )}
                            <p>Modified: {file.lastModified}</p>
                          </div>
                        </div>
                        <div className="flex space-x-1">
                          {file.status !== 'clean' && (
                            <Button size="sm" variant="destructive">
                              Quarantine
                            </Button>
                          )}
                          <Button size="sm" variant="outline">
                            <Eye className="h-4 w-4" />
                          </Button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Network Analysis Tab */}
          <TabsContent value="network" className="space-y-4">
            <Card>
              <CardHeader>
                <CardTitle>Network Connections Analysis</CardTitle>
                <CardDescription>
                  Found {networkConnections.filter(n => n.suspicious).length} suspicious connections
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="space-y-2 max-h-[500px] overflow-y-auto">
                  {networkConnections.map((conn, idx) => (
                    <div 
                      key={idx}
                      className={`p-3 border rounded-lg ${
                        conn.suspicious ? 'border-red-300 bg-red-50' : 'border-gray-200'
                      }`}
                    >
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <div className="flex items-center space-x-2 mb-2">
                            {conn.suspicious ? (
                              <AlertTriangle className="h-4 w-4 text-red-600" />
                            ) : (
                              <Activity className="h-4 w-4 text-green-600" />
                            )}
                            <span className="font-semibold text-sm">{conn.process}</span>
                            <Badge variant={conn.suspicious ? 'destructive' : 'outline'}>
                              {conn.state}
                            </Badge>
                          </div>
                          <div className="text-sm space-y-1">
                            <p>
                              <span className="text-gray-600">Local:</span>{' '}
                              <code className="bg-white px-1 rounded">:{conn.localPort}</code>
                            </p>
                            <p>
                              <span className="text-gray-600">Remote:</span>{' '}
                              <code className="bg-white px-1 rounded">
                                {conn.remoteIP}:{conn.remotePort}
                              </code>
                            </p>
                          </div>
                        </div>
                        <div className="flex space-x-1">
                          {conn.suspicious && (
                            <Button size="sm" variant="destructive">
                              Block
                            </Button>
                          )}
                          <Button size="sm" variant="outline">
                            <Eye className="h-4 w-4" />
                          </Button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Exploits Tab */}
          <TabsContent value="exploits" className="space-y-4">
            <div className="grid md:grid-cols-2 gap-4">
              <Card>
                <CardHeader>
                  <CardTitle className="text-sm flex items-center">
                    <Lock className="mr-2 h-4 w-4" />
                    SQL Injection Tester
                  </CardTitle>
                </CardHeader>
                <CardContent className="space-y-2">
                  <input 
                    type="text"
                    className="w-full p-2 border rounded text-sm"
                    placeholder="admin' OR '1'='1"
                  />
                  <Button size="sm" className="w-full">
                    <Terminal className="mr-2 h-4 w-4" />
                    Test Injection
                  </Button>
                </CardContent>
              </Card>

              <Card>
                <CardHeader>
                  <CardTitle className="text-sm flex items-center">
                    <Code className="mr-2 h-4 w-4" />
                    XSS Payload Tester
                  </CardTitle>
                </CardHeader>
                <CardContent className="space-y-2">
                  <input 
                    type="text"
                    className="w-full p-2 border rounded text-sm"
                    placeholder="<script>alert(1)</script>"
                  />
                  <Button size="sm" className="w-full">
                    <Terminal className="mr-2 h-4 w-4" />
                    Test XSS
                  </Button>
                </CardContent>
              </Card>

              <Card>
                <CardHeader>
                  <CardTitle className="text-sm flex items-center">
                    <Terminal className="mr-2 h-4 w-4" />
                    Command Injection
                  </CardTitle>
                </CardHeader>
                <CardContent className="space-y-2">
                  <input 
                    type="text"
                    className="w-full p-2 border rounded text-sm font-mono"
                    placeholder="127.0.0.1 && whoami"
                  />
                  <Button size="sm" className="w-full">
                    <Terminal className="mr-2 h-4 w-4" />
                    Test Command
                  </Button>
                </CardContent>
              </Card>

              <Card>
                <CardHeader>
                  <CardTitle className="text-sm flex items-center">
                    <Database className="mr-2 h-4 w-4" />
                    Path Traversal
                  </CardTitle>
                </CardHeader>
                <CardContent className="space-y-2">
                  <input 
                    type="text"
                    className="w-full p-2 border rounded text-sm font-mono"
                    placeholder="../../../etc/passwd"
                  />
                  <Button size="sm" className="w-full">
                    <Terminal className="mr-2 h-4 w-4" />
                    Test Path
                  </Button>
                </CardContent>
              </Card>
            </div>

            <Alert>
              <Shield className="h-4 w-4" />
              <AlertDescription>
                <strong>Safe Environment:</strong> All exploits are tested in an isolated sandbox. 
                No real systems are affected.
              </AlertDescription>
            </Alert>
          </TabsContent>
        </Tabs>
      )}
    </div>
  );
}
